var e,t;e=this,t=function(){const e='__TAB__LOADED_EVENT__',t='__TAB__CUSTOM_EVENT__',n='__TAB__HANDSHAKE_EVENT__',i='__TAB__ON_BEFORE_UNLOAD__',s='__PARENT_DISCONNECTED__',a='__HANDSHAKE_WITH_PARENT__',o='__PARENT_COMMUNICATED__';let r={},d={INDEX:'index',OBJECT:'object',BOTH:'both'};r.searchByKeyName=(e,t,n,i)=>{if(!e||!t)return!1;i=i||d[1];let s,a,o,r=-1;for(s=0;s<e.length;s++){if(a=e[s],!isNaN(n)&&parseInt(a[t],10)===parseInt(n,10)){r=s;break}if(isNaN(n)&&a[t]===n){r=s;break}}switch(-1===r&&(e[r]={}),i){case d.INDEX:o=r;break;case d.BOTH:o={obj:e[r],index:r};break;default:o=e[r]}return o};const l='open',h='close',g='Invalid JSON Object!',w='Some wrong message is being sent by Parent.',c='Configuration options required. Please read docs.',f='Url is needed for creating and opening a new window/tab. Please read docs.';let m,u={tabs:[],config:{},_remove:e=>{let t;t=r.searchByKeyName(u.tabs,'id',e.id,'index'),u.tabs.splice(t,1)},_preProcessMessage:e=>{try{e=u.config.stringify(e)}catch(e){throw new Error(g)}return e&&-1===e.indexOf(o)&&(e=o+e),e},addNew:e=>{u.tabs.push(e)},getOpened:()=>u.tabs.filter((e=>e.status===l)),getClosed:()=>u.tabs.filter((e=>e.status===h)),getAll:()=>u.tabs,closeTab:e=>{let t=r.searchByKeyName(u.tabs,'id',e);return t&&t.ref&&(t.ref.close(),t.status=h),u},closeAll:()=>{let e;for(e=0;e<u.tabs.length;e++)u.tabs[e]&&u.tabs[e].ref&&(u.tabs[e].ref.close(),u.tabs[e].status=h);return u},broadCastAll:(e,t)=>{let n,i=u.getOpened();for(e=u._preProcessMessage(e),n=0;n<i.length;n++)u.sendMessage(i[n],e,t);return u},broadCastTo:(e,t,n)=>{let i,s=u.getAll();return t=u._preProcessMessage(t),i=r.searchByKeyName(s,'id',e),u.sendMessage(i,t,n),u},sendMessage:(e,t,n)=>{let i=u.config.origin||'*';if(n&&e.ref[0])for(let n=0;n<e.ref.length;n++)e.ref[n].postMessage(t,i);else e.ref&&e.ref.top&&e.ref.top.postMessage(t,i)}};m=function(){function e(){}return e.generate=()=>{let t=e._getRandomInt,n=e._hexAligner;return n(t(32),8)+'-'+n(t(16),4)+'-'+n(16384|t(12),4)+'-'+n(32768|t(14),4)+'-'+n(t(48),12)},e._getRandomInt=e=>e<0?NaN:e<=30?0|Math.random()*(1<<e):e<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<e-30))*(1<<30):NaN,e._getIntAligner=e=>(t,n)=>{let i=t.toString(e),s=n-i.length,a='0';for(;s>0;s>>>=1,a+=a)1&s&&(i=a+i);return i},e._hexAligner=e._getIntAligner(16),e.prototype.toString=function(){return this.hexString},e}();var b=m;let p=e=>{if(!e)return!1;let t,n=document.querySelectorAll('['+e+']');for(t=0;t<n.length;t++)n[t].setAttribute('disabled','disabled')},_=e=>{if(!e)return!1;let t,n=document.querySelectorAll('['+e+']');for(t=0;t<n.length;t++)n[t].removeAttribute('disabled')};class y{constructor(){window.name=window.name||'PARENT_TAB'}create(e){return e=e||{},Object.assign(this,e),this.id=b.generate()||u.tabs.length+1,this.status='open',this.ref=window.open(this.url,e.windowName||'_blank',e.windowFeatures),p('data-tab-opener'),window.newlyTabOpened={id:this.id,name:this.name||this.windowName,ref:this.ref},u.addNew(this),this}}let T,E,N={_onLoad:t=>{let n,i,s=t.split(e)[1];if(s)try{s=u.config.parse(s),s.id&&(n=u.getAll(),n.length&&(window.newlyTabOpened=n[n.length-1],window.newlyTabOpened.id=s.id,window.newlyTabOpened.name=s.name||s.windowName))}catch(e){throw new Error(g)}if(window.newlyTabOpened)try{i=a,i+=u.config.stringify({id:window.newlyTabOpened.id,name:window.newlyTabOpened.name||window.newlyTabOpened.windowName,parentName:window.name}),u.sendMessage(window.newlyTabOpened,i,s.isSiteInsideFrame)}catch(e){throw new Error(g)}},_onCustomMessage:(e,t)=>{let n,i,s=e.split(t)[1];try{s=u.config.parse(s)}catch(e){throw new Error(g)}i={tabInfo:s,type:t},n=new CustomEvent('onCustomChildMessage',{detail:i}),window.dispatchEvent(n)},_onBeforeUnload:e=>{let t,n=e.split(i)[1];try{n=u.config.parse(n)}catch(e){throw new Error(g)}u.tabs.length&&(t=u.getAll(),window.newlyTabOpened=r.searchByKeyName(t,'id',n.id)||window.newlyTabOpened);let s=new CustomEvent('onChildUnload',{detail:n});window.dispatchEvent(s)},onNewTab:s=>{let a=s.data;return!(!a||'string'!=typeof a||!u.tabs.length)&&(!u.config.origin||u.config.origin===s.origin)&&void(a.indexOf(e)>-1?N._onLoad(a):a.indexOf(t)>-1?N._onCustomMessage(a,t):a.indexOf(n)>-1?N._onCustomMessage(a,n):a.indexOf(i)>-1&&N._onBeforeUnload(a))}};return{Parent:class{constructor(e){void 0===(e=e||{}).heartBeatInterval&&(e.heartBeatInterval=500),void 0===e.shouldInitImmediately&&(e.shouldInitImmediately=!0),'function'!=typeof e.parse&&(e.parse=JSON.parse),'function'!=typeof e.stringify&&(e.stringify=JSON.stringify),u.tabs=[],this.Tab=y,Object.assign(this,e),u.config=e,this.shouldInitImmediately&&this.init()}addInterval(){let e,t=u.getAll(),n=u.getOpened();if(!n||!n.length)return window.clearInterval(T),T=null,!1;for(e=0;e<t.length;e++)this.removeClosedTabs&&this.watchStatus(t[e]),t[e]&&t[e].ref&&(t[e].status=t[e].ref.closed?h:l);this.onPollingCallback&&this.onPollingCallback()}startPollingTabs(){T=window.setInterval((()=>this.addInterval()),this.heartBeatInterval)}watchStatus(e){if(!e||!e.ref)return!1;let t=e.ref.closed?h:l,n=e.status;if(!t||t===n)return!1;n===l&&t===h&&u._remove(e)}onChildUnload(e){this.onChildDisconnect&&this.onChildDisconnect(e.detail)}customEventUnListener(e){this.enableElements(),e.detail&&e.detail.type===n&&this.onHandshakeCallback?this.onHandshakeCallback(e.detail.tabInfo):e.detail&&e.detail.type===t&&this.onChildCommunication&&this.onChildCommunication(e.detail.tabInfo)}addEventListeners(){window.removeEventListener('message',N.onNewTab),window.addEventListener('message',N.onNewTab),window.removeEventListener('onCustomChildMessage',this.customEventUnListener),window.addEventListener('onCustomChildMessage',(e=>this.customEventUnListener(e))),window.removeEventListener('onChildUnload',this.onChildUnload),window.addEventListener('onChildUnload',(e=>this.onChildUnload(e))),window.onbeforeunload=()=>{u.broadCastAll(s)}}enableElements(){_('data-tab-opener')}getAllTabs(){return u.getAll()}getOpenedTabs(){return u.getOpened()}getClosedTabs(){return u.getClosed()}closeAllTabs(){return u.closeAll()}closeTab(e){return u.closeTab(e)}broadCastAll(e){return u.broadCastAll(e)}broadCastTo(e,t){return u.broadCastTo(e,t)}openNewTab(e){if(!e)throw new Error(c);if(!e.url)throw new Error(f);return E=new this.Tab,E.create(e),T||this.startPollingTabs(),E}init(){this.addEventListeners()}},Child:class{constructor(e){this.sessionStorageKey='__vwo_new_tab_info__',e||(e={}),void 0===e.handshakeExpiryLimit&&(e.handshakeExpiryLimit=5e3),void 0===e.shouldInitImmediately&&(e.shouldInitImmediately=!0),'function'!=typeof e.parse&&(e.parse=JSON.parse),'function'!=typeof e.stringify&&(e.stringify=JSON.stringify),this.tabName=window.name,this.tabId=null,this.tabParentName=null,Object.assign(this,e),this.config=e,this.shouldInitImmediately&&this.init()}_isSessionStorage(){return!(!('sessionStorage'in window)||!window.sessionStorage)}_getData(){return!!this.isSessionStorageSupported&&window.sessionStorage.getItem(this.sessionStorageKey)}_setData(e){return!!this.isSessionStorageSupported&&(window.sessionStorage.setItem(this.sessionStorageKey,e),e)}_restoreData(){if(!this.isSessionStorageSupported)return!1;if(this.isSessionStorageSupported){let e=this._getData();this._parseData(e)}}_parseData(e){let t;try{t=this.config.parse(e),this.tabId=t&&t.id,this.tabName=t&&t.name,this.tabParentName=t&&t.parentName}catch(e){throw new Error(w)}}onCommunication(e){let t,i=e.data;if(i&&'string'==typeof i&&(!this.config.origin||this.config.origin===e.origin)){if(window.clearTimeout(this.timeout),i.indexOf(s)>-1&&(this.config.onParentDisconnect&&this.config.onParentDisconnect(),window.removeEventListener('message',(e=>this.onCommunication(e)))),i.indexOf(a)>-1){let e;t=i.split(a)[1],this._setData(t),this._parseData(t),e={id:this.tabId,isSiteInsideFrame:this.config.isSiteInsideFrame},this.sendMessageToParent(e,n),this.config.onInitialize&&this.config.onInitialize()}if(i.indexOf(o)>-1){t=i.split(o)[1];try{t=this.config.parse(t)}catch(e){throw new Error(g)}this.config.onParentCommunication&&this.config.onParentCommunication(t)}}}addListeners(){window.onbeforeunload=e=>{let t={id:this.tabId,isSiteInsideFrame:this.config.isSiteInsideFrame};this.sendMessageToParent(t,i)},window.removeEventListener('message',(e=>this.onCommunication(e))),window.addEventListener('message',(e=>this.onCommunication(e)))}setHandshakeExpiry(){return window.setTimeout((()=>{this.config.onHandShakeExpiry&&this.config.onHandShakeExpiry()}),this.handshakeExpiryLimit)}sendMessageToParent(e,n){let i;e=(n||t)+this.config.stringify(e),window.top.opener&&(i=this.config.origin||'*',window.top.opener.postMessage(e,i))}getTabInfo(){return{id:this.tabId,name:this.tabName,parentName:this.tabParentName,isSiteInsideFrame:this.config.isSiteInsideFrame}}init(){this.isSessionStorageSupported=this._isSessionStorage(),this.addListeners(),this._restoreData(),this.sendMessageToParent(this.getTabInfo(),e),this.timeout=this.setHandshakeExpiry(),this.config.onReady&&this.config.onReady()}}}},'object'==typeof exports&&'undefined'!=typeof module?module.exports=t():'function'==typeof define&&define.amd?define(t):(e='undefined'!=typeof globalThis?globalThis:e||self).AcrossTabs=t();
